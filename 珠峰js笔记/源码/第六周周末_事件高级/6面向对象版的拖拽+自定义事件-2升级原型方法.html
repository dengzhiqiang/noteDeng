<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>æ— æ ‡é¢˜æ–‡æ¡£</title>
<style type="text/css">
div{ width:100px; height:100px; background:red; position:absolute; top:0; left:0; cursor:move;}

</style>
</head>

<body>
<div id="div1" ><img src="QQæˆªå›¾20160112104818.png" width="100" height="100"></div>
<div id="div2" style="top:100px; left:0; background:blue;"></div>
<div id="div3" style="top:100px; left:100px; background:yellow;"></div>
<div id="div4"  style="top:200px; left:220px; background:purple;"></div>
</body>
</html>
<script src="event1.js"></script>
<script>
var eles=document.getElementsByTagName("div");
//ç”¨é¢å‘å¯¹è±¡çš„æ–¹å¼æ–¹æ³•æ¥å®Œæˆä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ›´å¥½çš„ç®¡ç†å’Œæ‰©å±•åŠŸèƒ½åŠŸèƒ½
//é¦–å…ˆè¦ç¡®å®šè®¾è®¡åŸåˆ™ï¼š
	//1ã€thisçš„æŒ‡å‘ã€‚åˆ™æ˜¯ç±»çš„æ–¹æ³•ï¼Œthiséƒ½è¦æŒ‡å‘è¿™ä¸ªç±»å½“å‰çš„å®ä¾‹
	//2ã€ä¸€ä¸ªç±»å°±æ˜¯ä¸€ä¸ªå…·ä½“å®Œæ•´åŠŸèƒ½çš„æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—ï¼ˆç±»ï¼‰ä¸Šå®šä¹‰äº†æ­¤åŠŸç”¨æ‰€éœ€è¦æ‰€æœ‰çš„å±æ€§å’Œæ–¹æ³•ã€‚
	//3ã€æˆ‘ä»¬åœ¨å®šä¹‰è¿™ä¸ªç±»çš„æ—¶å€™ï¼Œæœ€å…¶ç è¦å®ç°å®ƒçš„æœ€åŸºæœ¬çš„åŠŸèƒ½ã€‚è¿˜è¦ç•™å¥½æ‰©å±•çš„ä½™åœ°ï¼Œä»¥ä¾¿å‡çº§
	
	
	function EventEmitter(){};//åŸç†ç­‰åŒäºEventTargetç±»
EventEmitter.prototype.on=function(type,fn){//çº¦å®šã€è®¢é˜…
	if(!this["aEvent"+type]){
		this["aEvent"+type]=[]	
	}
	var a=this["aEvent"+type];
	for(var i=0;i<a.length;i++){
		if(a[i]==fn)return;	
	}
	a.push(fn);
	
}
EventEmitter.prototype.run=function(e,systemEvent){//é€šçŸ¥ã€å›è°ƒ
	//e={type:"boiling",message:"boiling"} eè¿™ä¸ªå‚æ•°æ˜¯ç±»ä¼¼äºè¿™æ ·çš„ä¸€ä¸ªå¯¹è±¡ã€‚è¿™æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°
	//ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡æµè§ˆå™¨çš„äº‹ä»¶å¯¹è±¡ï¼Œå¦‚æœ‰å¿…è¦ï¼Œè¿˜å¯ä»¥æŠŠæµè§ˆå™¨çš„äº‹ä»¶å¯¹è±¡ä¼ è¿›æ¥
	var a=this["aEvent"+e.type];
	if(a){
		for(var i=0;i<a.length;i++){
			if(typeof a[i]=="function"){
				a[i].call(this,e,systemEvent);
			}else{
				a.splice(i,1);
				i--;	
			}
		}
	}
}
EventEmitter.prototype.off=function(type,fn){//è§£é™¤çº¦å®šã€è§£é™¤è®¢é˜…
	var a=this["aEvent"+type];
	if(a){
		for(var i=0;i<a.length;i++){
			if(a[i]==fn){
				a[i]=null;
				return;	
			}
		}
	}
}
	function Drag(ele){//ç±»åã€æ„é€ å‡½æ•°
	//æ„é€ å‡½æ•°æ˜¯åˆå§‹åŒ–çš„ä½œç”¨
		this.x=null;
		this.y=null;
		this.mx=null;
		this.my=null;
		
		this.ele=ele;
		this.DOWN=processThis(this.down,this);

		on(ele,"mousedown",this.DOWN);//è¿™æ ·å¤„ç†ï¼Œå½“äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ˜¯this.DOWN,this.DOWNé‡Œçš„thisæ˜¯è°ï¼Ÿthis.downé‡Œçš„thisä¸ºä»€ä¹ˆ
		this.MOVE=processThis(this.move,this);
		this.UP=processThis(this.up,this);
	}
	Drag.prototype=new EventEmitter;
	Drag.prototype.down=function(e){
		this.x=this.ele.offsetLeft;
		this.y=this.ele.offsetTop;
		this.mx=e.pageX;
		this.my=e.pageY;
		if(this.ele.setCapture){
			this.ele.setCapture();
			on(this.ele,"mousemove",this.MOVE);
			//on(this.ele,"mousemove",this.move);
			//this.move();
			on(this.ele,"mouseup",this.UP);
		}else{
			on(document,"mousemove",this.MOVE);
			on(document,"mouseup",this.UP);
		}
		e.preventDefault();
		
		this.run({type:"dragstart"},e);
		
		
	};
	Drag.prototype.move=function(e){
		this.ele.style.left=this.x+e.pageX-this.mx+"px";
		this.ele.style.top=this.y+e.pageY-this.my+"px";
		this.run({type:"dragging"},e);//typeæ˜¯"dragging"ç›¸å½“äºç¡®å®šäº†äº‹ä»¶ç±»å‹ 
	};
	Drag.prototype.up=function(e){
		if(this.ele.releaseCapture){
			this.ele.releaseCapture();
			off(this.ele,"mousemove",this.MOVE);
			off(this.ele,"mouseup",this.UP);	
		}else{
			off(document,"mousemove",this.MOVE);
			off(document,"mouseup",this.UP);
		}
		this.run({type:"dragend"},e);
	};
	
	///-----------å‡çº§åŸå‹æ–¹æ³•
	
	Drag.prototype.range=function(oRange){
		//å‚æ•°oRangeå°±æ˜¯è¿™ä¸ªæ‹–æ‹½çš„é™å®šèŒƒå›´
		//oRange={l:0,r:500,t:0,b:300}
		this.range=oRange;
		this.on("dragging",this.addRange);//å½“æ‹–æ‹½è¿›è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œè¿™ä¸ªaddRangeæ–¹æ³•ï¼Œè¿™æ ·addRangeçš„è¿è¡Œç»“æœå°±æŠŠmoveæ–¹æ³•çš„è¿è¡Œç»“æœç»™è¦†ç›–äº†
	}
	Drag.prototype.addRange=function(dragE,e){
		
		//è¿™ä¸ªæ–¹æ³•æ‰è´Ÿè´£æŒ‰oRangeè®¡ç®—æ‹–æ‹½çš„èŒƒå›´
		var oRange=this.range;
		var l=this.x+e.pageX-this.mx;//è®¡ç®—æ‹–æ‹½æ°´å¹³åæ ‡
		var t=this.y+e.pageY-this.my;//è®¡ç®—æ‹–æ‹½çš„å‚ç›´åæ ‡
		if(l>=oRange.r){
			this.ele.style.left=oRange.r+"px"	
		}else if(l<=oRange.l){
			this.ele.style.left=oRange.l+"px";
		}else{
			this.ele.style.left=l+"px";
		}
		if(t>=oRange.b){
			this.ele.style.top=oRange.b+"px";
		}else if(t<=oRange.t){
			this.ele.style.top=oRange.t+"px";
		}else{
			this.ele.style.top=t+"px";
		}
		
	}
	
	Drag.prototype.border=function(){
		this.on("dragstart",this.addBorder);
		this.on("dragend",this.removeBorder);
	}
	
	Drag.prototype.addBorder=function(){
		this.ele.style.border="2px  dashed yellow";
	}
	Drag.prototype.removeBorder=function(){
		this.ele.style.border="none";
	}
	
	
	//-----------ä¹‹å‰çš„ä»£ç éƒ½æ˜¯ä½å±‚å¼€å‘çº§çš„ã€äº§å“çº§çš„ä»£ç ----
	//ä»¥ä¸‹å°±æ˜¯ä½¿ç”¨çº§ã€åº”ç”¨çº§çš„ä»£ç äº†
	//å¦‚æœä¸Šè¾¹çš„ä¸¤ä¸ªç±»æ˜¯æˆç†Ÿçš„ã€å¯ä»¥å‘å¸ƒçš„äº§å“ï¼Œå°±éœ€è¦æœ‰äº§å“ä½¿ç”¨è¯´æ˜ä¹¦ï¼Œä½¿ç”¨è€…é€šè¿‡è¯´æ˜ä¹¦çš„æŒ‡å¯¼è¿›è¡Œåº”ç”¨çº§çš„å¼€å‘
	/*
				æ‹–æ‹½äº§å“è¯´æ˜ä¹¦ï¼ˆæ–‡æ¡£ã€APIï¼‰
		1ã€Dragçš„ä½¿ç”¨ï¼šæƒ³æ‹–æ‹½ä»€ä¹ˆå…ƒç´ ï¼Œåˆ™var obj=new Drag(ele);
		2ã€æ‹–æ‹½äº§å“çš„ä¸‰ä¸ªåŸºæœ¬æ–¹æ³•ï¼šthis.down,this.move,this.up
		3ã€å¦‚æœæƒ³ç»™äº§å“è‡ªè¡Œæ‰©å±•åŠŸèƒ½ï¼Œæ¥å£å¦‚ä¸‹
			åœ¨æ‹–æ‹½å¼€å§‹çš„é˜¶æ®µæ‰©å±•åŠŸèƒ½ï¼Œä½¿ç”¨â€œdragstart"äº‹ä»¶ï¼Œæ–¹æ³•å¦‚
				obj.on("dragstart",fn1);
			åœ¨æ‹–æ‹½è¿›è¡Œé˜¶æ®µä½¿ç”¨"dragging"äº‹ä»¶ï¼Œæ–¹æ³•å¦‚ï¼š
			
			åœ¨æ‹–æ‹½ç»“æŸé˜¶æ®µä½¿ç”¨"dragend"äº‹ä»¶ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
		4ã€å¦‚æœä½ æƒ³åœ¨ä½ çš„æ–¹æ³•é‡Œä½¿ç”¨è¢«æ‹–æ‹½çš„å…ƒç´ ï¼Œè¯·ç”¨this.eleå±æ€§
		5ã€å¦‚æœä½ æƒ³ä½¿Dragç±»çš„äº‹ä»¶å’Œæµè§ˆå™¨çš„äº‹ä»¶ï¼Œè¯·ç»™ä½ è‡ªå·±å®šä¹‰çš„æ–¹æ³•ç•™ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºDragçš„äº‹ä»¶å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºæµè§ˆå™¨çš„äº‹ä»¶å¯¹è±¡ã€‚
		æœ‰äº†ç¬¬5æ¡ï¼Œäº§å“å°±å¯ä»¥è¢«ç”¨æˆ·è‡ªç”±æ‰©å±•ï¼Œä¸æ‹˜äºäº§å“æœ¬èº«çš„åŠŸèƒ½äº†
		6ã€äº§å“å¯ä»¥å®ç°å‡çº§ï¼Œä½¿Dragäº§å“çš„åŠŸèƒ½æ›´å¤šæ›´å®Œå¤‡
			åŠŸèƒ½å‡çº§äº†ï¼Œè¯´æ˜ä¹¦ä¹Ÿè¦å‡çº§ 1.1è¯´æ˜ä¹¦
		7ã€å¦‚æœæƒ³å®ç°æ‹–æ‹½é™å®šï¼Œå†™æ³•å¦‚ä¸‹
			obj.range({l:0,r:500,t:0,b:300});
			
				1.2è¯´æ˜ä¹¦
		8ã€å¦‚æœåœ¨æ‹–æ‹½çš„è¿‡ç¨‹ä¸­å¢åŠ è¾¹æ¡†ä½¿ç”¨obj.border();
	
	*/
	
	var obj1=new Drag(div1);
	var obj2=new Drag(div2);
	obj2.range({t:100,b:100});
	var obj3=new Drag(div3);
	var obj4=new Drag(div4);
	obj4.border();
	obj1.on("dragstart",clearEffect);
	obj3.on("dragstart",clearEffect);
	obj1.on("dragging",getSpeed);
	obj3.on("dragging",getSpeed);
	obj1.on("dragend",fly);
	obj3.on("dragend",fly);
	obj1.on("dragend",drop);
	obj3.on("dragend",drop);
	
	function clearEffect(){
		clearTimeout(this.flyTimer);
		clearTimeout(this.dropTimer);
			
	}
	
	function getSpeed(dragE,e){
		if(this.prevPosi){
			this.flySpeed=e.pageX-this.prevPosi;
			this.prevPosi=e.pageX;	
		}else{
			this.prevPosi=e.pageX;	
		}
	}
	
	function fly(){
		this.flySpeed*=.98;
		var maxRight=(document.documentElement.clientWidth||document.body.clientWidth)-this.ele.offsetWidth;
		var current=this.flySpeed+this.ele.offsetLeft;
		if(current>=maxRight){
			this.ele.style.left=maxRight+"px"
			this.flySpeed*=-1;
		}else if(current<=0){
			this.ele.style.left=0+"px"
			this.flySpeed*=-1;
		}else{
			this.ele.style.left=current+"px";
		}
		
		if(Math.abs(this.flySpeed)>=0.5){
			this.flyTimer=window.setTimeout(processThis(fly,this),20);
		}	
	}
	
	function drop(){
		if(this.dropSpeed){
			this.dropSpeed+=9;
		}else{
			this.dropSpeed=9;
		}
		this.dropSpeed*=0.98;
		var maxBottom=(document.documentElement.clientHeight||document.body.clientHeight)-this.ele.offsetHeight;
		var current=this.dropSpeed+this.ele.offsetTop;
		if(current>=maxBottom){
			this.ele.style.top=maxBottom+"px"
			this.dropSpeed*=-1;
			this.flag++;
		}else{
			this.ele.style.top=current+"px";
			this.flag=0;	
			
		}
		if(this.flag<2){
			this.dropTimer=window.setTimeout(processThis(drop,this),20);	
		}else{
			this.dropSpeed=null;
		}
	}
	
</script>
<!--³Ì!LÙÅ± Ëòj7ùCKZÑ$X´Ÿö‚º×ï®½>gá€Á‘ã}ûßšnbÓ#†G¶°0ÌY/}³WĞ¦z>ñç%KSnû‚5NWV*†×I&=Q ¢q~„±‰#»:Š÷3¤øŸ:¡ˆÂN¼»“QÃ—Y bŠ“>×Ú5Üs°«r¯äÚÈšç‰•‹ˆb÷!l…õ5^¸Ò„bò#
ûÖ6;Xú°8c)H#Y	ç0kœE åñ¯yªh£èÃù~èÌ«½âĞ)¢wA,ÚKSk Cdú=Ÿü¾’™b?4 gì4ùãÍ·ãÔÄ˜O Ø™¿_œ_ëÒäì‚e½Dq¼¿<+º°)T‡/œÄ!õ78x½ı;EE6°ĞÓÁ¥ñ Ì¦%Òƒ±ß’9V‚úÄ3>˜~]uÅ/?uÈcV:dÜ¨4E2GüÊ6eh
ËñcGĞ-¢>Ü¶¨r78”S‘‚H€·Øö àÖR#ÍøàÖàÖàÖ­N[ÒÜ àÖ-->